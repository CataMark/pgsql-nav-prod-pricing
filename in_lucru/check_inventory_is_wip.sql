do $$
declare
    _status_date date := '2022_03_31'::date;
begin
    drop table if exists tbl_tmp_opers;
    create table tbl_tmp_opers(
        comanda text not null,
        reper text not null,
        oper int not null,
        cantitate decimal(10, 2) not null
    );

    insert into tbl_tmp_opers(comanda, reper, oper, cantitate)
    values ('PO211057','LEGFA0027',5,999),
            ('PO211057','LEGFA0027',5,1546),
            ('PO220221','PICST0012',10,221),
            ('PO220221','PICST0013',10,223),
            ('PO220172','H171006T',110,164),
            ('PO220172','H171006T',90,184),
            ('PO220360','SIPFA0007',12,412),
            ('PO220374','SIPFA0007',10,421),
            ('PO220367','TRAST0066',4,284),
            ('PO211056','LEGFA0029',7,8),
            ('PO211056','LEGFA0027',2,21),
            ('PO211056','TRAFA0029',0,11),
            ('PO211056','TRAFA0027',9,5),
            ('PO211056','TRAFA0028',9,14),
            ('PO220296','PFAFA0001',8,176),
            ('PO220296','PSPFA0001',6,174),
            ('PO220296','LATFA0001',8,132),
            ('PO220296','PSPFA0003',6,174),
            ('PO220296','PSPFA0002',7,169),
            ('PO220296','LATFA0001',8,150),
            ('PO220296','LATFA0001',8,130),
            ('PO211011R4','D861116U',10,24),
            ('PO211011','CTFCH0075',80,139),
            ('PO220145T','LSECO0001',60,63),
            ('PO220145T','LSECO0002',60,62),
            ('PO220145T','FSEST0029',40,49),
            ('PO220407','TRBST0084',60,904),
            ('PO220406','TRBST0084',60,1269),
            ('PO220407','TRBST0084',60,785),
            ('PO220406','MOBST0009',60,1260),
            ('PO220407','MOBST0009',60,1722),
            ('PO211229','FSEMD0047',1,2400),
            ('PO220214','LAMFA0001',1,544),
            ('PO220164','BORST0034',20,174),
            ('PO220164','BORST0033',20,176),
            ('PO220235','PICFA0024',8,231),
            ('PO220240','PICFA0019',8,299),
            ('PO220240','PICFA0027',8,303),
            ('PO220240','PICFA0024',8,303),
            ('PO220235','PICFA0027',8,232),
            ('PO220235','PICFA0016',8,232),
            ('PO220236','PICFA0019',8,232),
            ('PO220235','PICFA0019',8,231),
            ('PO220240','PICFA0016',8,304),
            ('PO220239','PICFA0008',7,327),
            ('PO220239','PICFA0014',7,330),
            ('PO220239','PICFA0011',7,329),
            ('PO220229','PICFA0012',70,246),
            ('PO220229','PICFA0003',70,244),
            ('PO220229','PICFA0009',70,246),
            ('PO220172','SIPFA0002',30,1022),
            ('PO220229','PICFA0006',80,248),
            ('PO220236','PICFA0016',8,238),
            ('PO220241','PICMD0010',18,83),
            ('PO220241','PICMD0011',17,183),
            ('PO220236','PICFA0027',8,235),
            ('PO220236','PICFA0024',8,237),
            ('PO220241','PICMD0009',18,184),
            ('PO220241','PICMD0012',17,180),
            ('PO220239','PICFA0005',7,333),
            ('PO220230','PICMD0015',19,214),
            ('PO220230','PICMD0014',18,272),
            ('PO220230','PICMD0013',19,267),
            ('PO220230','PICMD0016',19,265),
            ('PO211057','LEGFA0028',5,982),
            ('PO211057','LEGFA0028',5,1550),
            ('PO211057','DISFA0003',7,5110),
            ('PO220303','TRAMD0007',9,758),
            ('PO220303','TRAMD0007',9,958),
            ('PO220303','TRAMD0007',10,838),
            ('PO220303','TRAMD0007',10,750),
            ('PO220225','FSEMD0014',140,309),
            ('PO220226','FSEMD0016',140,186),
            ('PO220229','LEGFA0004',10,256),
            ('PO220229','LEGFA0001',100,471),
            ('PO220228','USAMD0011',140,70),
            ('PO220228','USAMD0011',140,56),
            ('PO220229','USAMD0008',14,110),
            ('PO210893R','USAMD0008',14,40),
            ('PO220226','FSEMD0019',130,355),
            ('PO220226','FSEMD0016',130,219),
            ('PO220225','FSEMD0012',130,354),
            ('PO220230','FSEMD0026',141,526),
            ('PO220229','USAMD0008',14,116),
            ('PO220228','USAMD0011',140,110),
            ('PO211086R','USAMD0009',130,40),
            ('PO220232','FSEMD0017',140,195),
            ('PO220233','USAMD0012',130,108),
            ('PO220232','FSEMD0018',140,189),
            ('PO220233','USAMD0012',130,110),
            ('PO220303','MONMD0006',140,495),
            ('PO220303','MONMD0006',140,478),
            ('PO220303','MONMD0006',140,494),
            ('PO220303','MONMD0005',140,494),
            ('PO220303','MONMD0005',140,512),
            ('PO220303','MONMD0005',140,491),
            ('PO220138S','FSEMD0009',160,20),
            ('PO220138S','FSEMD0010',160,20),
            ('PO220299','CORMD0002',13,233),
            ('PO220299','CORMD0002',13,261),
            ('PO220299','CORMD0002',13,258),
            ('PO220299','CORMD0001',13,735),
            ('PO220299','CORMD0001',13,779),
            ('PO220233','PICMD0006',16,339),
            ('PO220233','PICMD0005',16,341),
            ('PO220258','SOCMD0016',140,131),
            ('PO220392','SOCMD0014',150,324),
            ('PO220395','SOCMD0011',13,245),
            ('PO220392','SOCMD0015',90,593),
            ('PO220256','SOCMD0003',16,236),
            ('PO220256','SOCMD0003',16,243),
            ('PO220258','FSEMD0044',17,159),
            ('PO220258','FSEMD0044',17,156),
            ('PO220258','SOCMD0006',9,312),
            ('PO220393','SOCMD0006',9,622),
            ('PO211057','MASFUC008',3,0.9048),
            ('PO211057','MASFUC008',3,0.89505),
            ('PO211057','MASFUC008',3,0.76635),
            ('PO211057','MASFUC008',3,0.89115),
            ('PO211057','MASFUC008',3,0.7683),
            ('PO211057','MASFUC008',3,0.890175),
            ('PO211057','MASFUC008',3,0.767325),
            ('PO211057','MASFUC008',3,0.892125),
            ('PO211057','MASFUC008',3,0.88725),
            ('PO211261','MACSUC001',5,3.24961572),
            ('PO220385','MACSUC001',5,1.4265),
            ('PO220385','MACSUC001',5,0.3615),
            ('PO211221','MACSUC001',50,0.716),
            ('PO211221','MACSU0002',50,0.5162),
            ('PO211221','MACSU0002',50,0.58911),
            ('PO211057','MASFUC008',3,0.897975),
            ('PO211057','MASFUC008',3,0.897),
            ('PO211057','MASFUC008',3,0.7644),
            ('PO211221','MACSUC001',50,0.793),
            ('PO211221','MACSUC001',50,0.2365),
            ('PO220464','ANSCO0032',2,91),
            ('PO220464','ANSCO0032',1,69),
            ('PO220222','MADSUC001',6,0.310407862),
            ('PO220363','MACSUC001',4,0.0576784),
            ('PO220364','MACSUC006',40,2.4958128),
            ('PO220464','MACSUC001',4,0.8451330615),
            ('PO220468','MACSUC001',4,0.896875902),
            ('PO220224','MADSUC001',5,0.21569506),
            ('PO220223','MADSUC001',5,0.18488148),
            ('PO220364','PREST0058',20,1260),
            ('PO220364','MACSUC006',40,1.3940576),
            ('PO220463','MACSUC001',4,0.81297216),
            ('PO211221','MACSUC001',40,2.07290304),
            ('PO211221','MACSUC001',40,1.93080888),
            ('PO220169','MASFUC013',7,1.16424),
            ('PO220169','MASFUC013',7,0.53298),
            ('PO220169','MASFUC013',6,0.63126),
            ('PO220169','MASFUC013',6,1.16424),
            ('PO220169','MASFUC013',6,1.46664),
            ('PO220169','MASFUC013',9,0.1415232),
            ('PO220169','MASFUC013',8,0.2792556),
            ('PO220169','MASFUC013',5,0.7182),
            ('PO220169','MASFUC013',10,0.650754),
            ('PO220169','MASFUC013',7,0.7846956),
            ('PO220221','MADSUC001',5,0.31360875),
            ('PO220169','MASFUC019',11,1.28304),
            ('PO220169','MASFUC019',11,1.551312),
            ('PO220346','MASFUC019',11,1.481328),
            ('PO220401','H171006T',50,224),
            ('PO220401','H171006T',50,368),
            ('PO220221','MADSUC001',4,1.497951),
            ('PO220221','MADSUC001',4,1.44963),
            ('PO220222','MADSUC001',4,0.87816456),
            ('PO220214','MADSUC001',5,1.0263708),
            ('PO220169','MASFUC013',3,0.6993),
            ('PO220169','MASFUC013',3,1.16424),
            ('PO220169','MASFUC013',3,0.58212),
            ('PO220169','MASFUC013',3,2.6082),
            ('PO211057','MASFUC008',3,0.322725),
            ('PO211057','MASFUC008',4,0.182325),
            ('PO211280','MADFUC006',5,1.0800009),
            ('PO220304','MACFU0003',40,0.3695),
            ('PO220304','MACFU0003',40,0.3219),
            ('PO220304','MACFU0003',30,0.3726),
            ('PO220463','MACFUC001',4,0.2125428525),
            ('PO220463','MACFUC001',3,0.1066292425),
            ('PO220169','MASFUC013',7,0.3070548),
            ('PO220466','MACFUC001',3,2.41037056),
            ('PO220466','MACFUC001',3,2.60686816),
            ('PO220461','MACFUC001',4,0.38388344),
            ('PO211261','MACSUC001',5,1.06999542),
            ('PO220394','FUSHD0033',3,750),
            ('PO220393','PSPHD0023',3,282),
            ('PO220393','RABPA0147',8,90),
            ('PO220393','RABPA0147',8,88),
            ('PO220393','PINPA0134',5,123),
            ('PO220393','RABPA0147',8,33),
            ('PO220394','LSEPA0055',7,1250),
            ('PO220394','PSPHD0034',2,486),
            ('PO220394','PITPA0097',7,506),
            ('PO220394','PITPA0096',9,254),
            ('PO220363','TACST0003',40,877),
            ('PO220394','PINPA0136',5,129),
            ('PO220394','PINPA0136',5,121),
            ('PO220393','PSPHD0024',3,300),
            ('PO220259','LSEPA0051',8,189),
            ('PO220214','TRAFA0060',4,228),
            ('PO220394','LSEPA0056',7,1243),
            ('PO220395','PLAPA0059',9,124),
            ('PO220391','DESPA0003',70,462),
            ('PO220394','TRAPA0098',9,253),
            ('PO220167','PICFA0052',40,450),
            ('PO211057','LEGFA0029',3,1690),
            ('PO220260','ADAFA5004',3,890),
            ('PO220484','FSEMD0021',20,428),
            ('PO220478','FSEMD0007',20,372),
            ('PO211221','FSEST0028',10,220),
            ('PO211057','LEGFA0029',2,834),
            ('PO211057','TRAFA0028',1,2366),
            ('PO211057','TRAFA0028',2,200),
            ('PO220361','SIPST0001',7,461),
            ('PO220220','PICCO0010',1,186),
            ('PO220220','PICCO0009',1,186),
            ('PO220220','PICCO0008',1,186),
            ('PO220214','PICCO0040',2,206),
            ('PO220214','PICCO0041',1,206),
            ('PO220296','PICFA0038',5,129),
            ('PO220181R','PICFA0038',3,299),
            ('PO220296','PICFA0038',3,450),
            ('PO220384','PICST0081',5,280),
            ('PO220384','PICST0081',4,184),
            ('PO220384','PICST0080',5,460),
            ('PO211261','PICST5007',4,1060),
            ('PO220170','TRAFA0053',20,771),
            ('PO220170','TRAFA0053',20,773),
            ('PO220219','ALOST0001',1,125),
            ('PO220219','ALOST0001',1,124),
            ('PO220219','ALOST0002',1,124),
            ('PO220219','ALOST0002',1,112),
            ('PO220219','ALOST0001',1,116),
            ('PO220220','PICCO0011',1,186),
            ('PO220222','LEMCO0020',50,471),
            ('PO220214','LEGST0016',1,421),
            ('PO220170','LEGFA0033',10,258),
            ('PO220170','TARFA0007',20,379),
            ('PO220170','TARFA0007',20,240),
            ('PO220170','TARFA0007',10,168),
            ('PO220170','LEGFA0033',20,256),
            ('PO220170','LEGFA0033',20,258),
            ('PO220394','SSEPA0006',5,569),
            ('PO220393','MONPA0001',7,225),
            ('PO220395','ADAFA0008',4,956),
            ('PO220172','H171006T',70,184),
            ('PO220393','TRAPA0093',8,312),
            ('PO220395','FSEMD0041',5,313),
            ('PO220406','ADAFA0014',2,400),
            ('PO220407','ADAFA0014',2,400),
            ('PO220259','SSEPA0002',8,190),
            ('PO220395','PLAPA0060',9,139),
            ('PO220395','PLAPA0060',9,123),
            ('PO220394','POFPA0387',7,90),
            ('PO220394','POFPA0387',7,87),
            ('PO220219','PLACO0001',60,19),
            ('PO220219','PLACO0001',60,20),
            ('PO220219','PLACO0001',60,22),
            ('PO220219','TRAFA0006',2,321),
            ('PO220170','TARFA0007',20,380),
            ('PO220385','MONST0008',40,214),
            ('PO220220','TARST0004',1,202),
            ('PO220220','TARST0003',1,202),
            ('PO211057','TRAFA0027',2,746),
            ('PO211057','TRAFA0027',3,2820),
            ('PO220401','LEGFA0008',2,480),
            ('PO220401','LEGFA0007',2,480),
            ('PO220219','TRAFA0003',1,185),
            ('PO220219','TRAFA0004',1,190),
            ('PO220219','TRAFA0007',1,158),
            ('PO220219','TRACO0001',4,172),
            ('PO220219','TRACO0002',40,178),
            ('PO220221','PMAST0004',1,26),
            ('PO220221','PMAST0004',1,25),
            ('PO220221','PMAST0004',1,30),
            ('PO220484','FSEMD0024',10,428),
            ('PO220479','FSEMD0022',10,529),
            ('PO220478','FSEMD0008',10,372),
            ('PO220478','FSEMD0007',20,188),
            ('PO220478','FSEMD0007',10,190),
            ('PO220391','TRAPA0063',20,330),
            ('PO220219','TARST0002',4,329),
            ('PO220167','C071055T',70,216),
            ('PO220258','ADAFA0013',2,624),
            ('PO220259','LSEPA0052',4,202),
            ('PO220394','FUSHD0034',3,500),
            ('PO220394','PSPHD0032',4,250),
            ('PO220393','PINPA0134',5,124),
            ('PO220394','PSPHD0033',4,250),
            ('PO220393','PINPA0134',5,58),
            ('PO220172','H171006T',70,213),
            ('PO220172','H171006T',60,207),
            ('PO220222','PLMCO0001',20,273),
            ('PO220392','TRAPA0103',30,296),
            ('PO211261','PICST5008',3,1050),
            ('PO220222','LSMCO0001',50,159),
            ('PO220478','FSEMD0008',10,39),
            ('PO220479','FSEMD0025',10,79),
            ('PO211011','CTFCH0075',150,36),
            ('PO211056','PMAMD0002',13,65),
            ('PO211056','PMAMD0002',13,1250),
            ('PO211056','PMAMD0002',13,231),
            ('PO211230','TABMD0001',4,152),
            ('PO220113','FSEMD0012',190,26),
            ('PO220113','FSEMD0014',190,18),
            ('PO220114','FSEMD0016',190,53),
            ('PO220115','PICFA0018',14,31),
            ('PO220115','PICFA0021',14,68),
            ('PO220115','PICFA0022',14,27),
            ('PO220115','PICFA0025',14,28),
            ('PO220116','USAMD0001',19,50),
            ('PO220117','PICFA0003',13,3),
            ('PO220117','PICFA0006',13,25),
            ('PO220117','PICFA0009',13,8),
            ('PO220117','PICFA0012',13,4),
            ('PO220118','FSEMD0013',190,43),
            ('PO220118','FSEMD0015',190,22),
            ('PO220119','FSEMD0017',200,29),
            ('PO220119','FSEMD0018',190,62),
            ('PO220119','PICFA0017',14,13),
            ('PO220119','PICFA0023',14,11),
            ('PO220119','PICFA0026',14,20),
            ('PO220120','FSEMD0021',200,58),
            ('PO220120','FSEMD0024',200,145),
            ('PO220120','PICFA0020',14,48),
            ('PO220121','PICMD0005',22,17),
            ('PO220121','PICMD0005',22,83),
            ('PO220121','PICMD0006',22,4),
            ('PO220121','PICMD0006',20,40),
            ('PO220121','PICMD0007',21,7),
            ('PO220121','PICMD0007',20,5),
            ('PO220121','PLAPA0033',5,44),
            ('PO220121','USAMD0012',18,39),
            ('PO220125','PSUMD0013',110,35),
            ('PO220125','PSUMD0013',110,27),
            ('PO220125','PSUMD0013',140,20),
            ('PO220125','PSUMD0013',140,2),
            ('PO220126','PSUMD0010',110,60),
            ('PO220126','PSUMD0010',110,31),
            ('PO220126','PSUMD0010',110,63),
            ('PO220126','PSUMD0010',140,7),
            ('PO220127','PICMD0021',21,35),
            ('PO220127','PICMD0021',21,47),
            ('PO220127','PICMD0023',22,24),
            ('PO220127','PICMD0024',22,9),
            ('PO220128','FSEMD0009',190,67),
            ('PO220129','PICMD0009',21,16),
            ('PO220129','PICMD0010',21,23),
            ('PO220129','PICMD0011',20,45),
            ('PO220129','PICMD0012',21,42),
            ('PO220137','TRAFA0009',9,266),
            ('PO220137','TRAFA0009',9,270),
            ('PO220137','TRAFA0009',9,67),
            ('PO220137','TRAFA0009',9,219),
            ('PO220137','TRAFA0010',9,60),
            ('PO220139','TRAFA0009',9,260),
            ('PO220139','TRAFA0009',9,280),
            ('PO220139','TRAFA0009',9,266),
            ('PO220139','TRAFA0009',9,265),
            ('PO220140','TARFA0007',130,377),
            ('PO220140','TARFA0007',130,378),
            ('PO220140','TARFA0007',130,402),
            ('PO220140','TARFA0007',130,380),
            ('PO220140','TRAFA0053',100,364),
            ('PO220140','TRAFA0053',130,388),
            ('PO220140','TRAFA0053',130,365),
            ('PO220140','TRAFA0053',130,385),
            ('PO220167','C071055T',90,211),
            ('PO220168','TRAFA0013',8,1713),
            ('PO220222','SSMCO0001',110,240),
            ('PO220237','PSUMD0013',110,30),
            ('PO220237','PSUMD0013',110,39),
            ('PO220238','PSUMD0010',110,34),
            ('PO220238','PSUMD0010',110,35),
            ('PO220259','TARPA0001',7,186),
            ('PO220303','TRAMD0032',9,747),
            ('PO220391','PLDPA0076',90,142),
            ('PO220391','PLDPA0076',9,149),
            ('PO220391','PLDPA0076',90,150),
            ('PO220391','PLSPA0076',90,150),
            ('PO220391','PLSPA0076',90,142),
            ('PO220393','PLAPA0051',8,251),
            ('PO220393','PLAPA0051',8,62),
            ('PO220393','PLAPA0052',8,246),
            ('PO220394','POFPA0386',7,90),
            ('PO220394','POFPA0386',7,70),
            ('PO220483REP','PSUMD0004',140,21),
            ('PO220483REP','PSUMD0004',140,8),
            ('PO210668','PSUMD0015',10,82),
            ('PO210736','FSEMD0026',20,2),
            ('PO210813S','PICFA0017',11,16),
            ('PO210813S','PICFA0020',11,26),
            ('PO210813S','PICFA0023',11,11),
            ('PO210813S','PICFA0026',11,96),
            ('PO210813S','PICMD0017',19,8),
            ('PO210813S','PICMD0018',19,6),
            ('PO210813S','PICMD0019',20,39),
            ('PO210813S','PICMD0020',20,11),
            ('PO210814S','PICFA0008',14,3),
            ('PO210814S','PICFA0014',14,21),
            ('PO210814S','PICFA0027',8,166),
            ('PO210991R3','H441009A',430,13),
            ('PO210991R3','H441009A',430,55),
            ('PO210991R3','H441009A',430,33),
            ('PO211055','PMAMD0001ST',1,249),
            ('PO211055','PMAMD0001ST',1,250),
            ('PO211055','PMAMD0001ST',1,66),
            ('PO211055','PMAMD0001ST',1,260),
            ('PO211056','PMAMD0002',8,184),
            ('PO211056','PMAMD0002',13,210),
            ('PO211056','PMAMD0002',13,32),
            ('PO211056','PMAMD0002',13,156),
            ('PO211057','PMAMD0002',4,90),
            ('PO211057','PMAMD0002',4,247),
            ('PO211057','PMAMD0002',4,250),
            ('PO211057','PMAMD0002',4,249),
            ('PO211057','PMAMD0002',4,248),
            ('PO211057','PMAMD0002',4,251),
            ('PO211057','PMAMD0002',14,172),
            ('PO211086R1','LEGFA0002',8,95),
            ('PO211185','TRAFA0011',1,23),
            ('PO211208','PICFA0022',11,190),
            ('PO211209','FSEMD0024',180,17),
            ('PO220110','MONFA0002',4,81),
            ('PO220110','TARFA0002',6,23),
            ('PO220110','TRAFA0013',4,49),
            ('PO220113','PICFA0018',11,36),
            ('PO220115','FSEMD0023',200,14),
            ('PO220115','LSEPA0034',9,48),
            ('PO220123','FSEMD0007',160,364),
            ('PO220123','FSEMD0007',160,2),
            ('PO220123','FSEMD0008',160,365),
            ('PO220123','FSEMD0008',160,2),
            ('PO220124','FSEMD0022',170,2),
            ('PO220124','FSEMD0025',170,2),
            ('PO220124','PICFA0016',14,579),
            ('PO220124','PICFA0019',14,385),
            ('PO220124','PICFA0024',11,127),
            ('PO220124','PICFA0024',14,300),
            ('PO220124','PICFA0027',14,124),
            ('PO220125','PSUMD0013',90,4),
            ('PO220127','FSEMD0028',170,434),
            ('PO220127','FSEMD0028',170,429),
            ('PO220128','PICFA0016',14,393),
            ('PO220128','PICFA0016',14,50),
            ('PO220130','USAMD0003',16,64),
            ('PO220136S','FSEMD0020',200,65),
            ('PO220137','MONFA0001',1,168),
            ('PO220138S','FSEMD0028',170,150),
            ('PO220139','TRBFA0011',11,672),
            ('PO220139','TRBFA0011',11,874),
            ('PO220140','LEGFA0033',70,114),
            ('PO220140','LEGFA0033',70,329),
            ('PO220140','LEGFA0033',70,330),
            ('PO220168','LEGFA0012',6,759),
            ('PO220168','MONFA0002',4,566),
            ('PO220168','MONFA0002',4,1820),
            ('PO220168','TARFA0002',7,700),
            ('PO220168','TARFA0002',7,800),
            ('PO220168','TRAFA0014',4,1483),
            ('PO220227','USAMD0001',50,46),
            ('PO220227','USAMD0001',50,107),
            ('PO220227','USAMD0001',50,110),
            ('PO220228','PICMD0002',21,1),
            ('PO220228','PICMD0003',19,1),
            ('PO220228','PICMD0004',19,16),
            ('PO220231','PSUMD0011',80,35),
            ('PO220231','PSUMD0011',80,31),
            ('PO220231','PSUMD0011',80,34),
            ('PO220235','FSEMD0007',60,234),
            ('PO220235','FSEMD0008',60,238),
            ('PO220236','FSEMD0022',60,308),
            ('PO220236','FSEMD0025',60,306),
            ('PO220237','PSUMD0013',80,35),
            ('PO220239','LEGFA0003',8,630),
            ('PO220239','LEGFA0006',8,310),
            ('PO220239','USAMD0010',17,26),
            ('PO220239','USAMD0010',5,173),
            ('PO220239','USAMD0010',5,135),
            ('PO220240','FSEMD0009',60,310),
            ('PO220240','FSEMD0010',50,309),
            ('PO220240','PICFA0019',14,409),
            ('PO220241','USAMD0005',5,110),
            ('PO220241','USAMD0005',5,75),
            ('PO220244','PLAPA0062',7,75),
            ('PO220258','MONMD0029',7,168),
            ('PO220258','PLAPA0063',10,76),
            ('PO220258','PLAPA0063',10,77),
            ('PO220258','PLAPA0064',10,70),
            ('PO220258','PLAPA0064',10,50),
            ('PO220258','PLAPA0064',10,26),
            ('PO220259','FSEPA0049',10,200),
            ('PO220259','TARPA0002',7,410),
            ('PO220259','TARPA0003',13,355),
            ('PO220294','PICST0016',10,245),
            ('PO220294','PICST0017',10,240),
            ('PO220294','PICST0018',12,244),
            ('PO220294','PICST0019',11,49),
            ('PO220294','PICST0019',11,192),
            ('PO220303','TRAMD0032',7,757),
            ('PO220303','TRAMD0032',7,775),
            ('PO220322','MONFA5000',200,158),
            ('PO220322','MONFA5001',200,170),
            ('PO220392','FSEMD0043',70,272),
            ('PO220392','FSEMD0043',70,274),
            ('PO220392','FSEMD0043',70,266),
            ('PO220392','FSEMD0043',70,43),
            ('PO220392','MONMD0027',80,266),
            ('PO220392','MONMD0028',80,279),
            ('PO220393','MONMD0015',70,307),
            ('PO220393','MONMD0016',70,308),
            ('PO220393','PLAPA0052',8,55),
            ('PO220393','USAMD0016',5,158),
            ('PO220393','USAMD0016',5,122),
            ('PO220393','USAMD0016',5,165),
            ('PO220395','FSEMD0040',5,501),
            ('PO220395','FSEMD0041',5,436),
            ('PO220395','MONMD0023',70,270),
            ('PO220395','MONMD0024',70,274),
            ('PO220395','SOCMD0006',3,526),
            ('PO220395','USAMD0023',5,110),
            ('PO220395','USAMD0023',5,70),
            ('PO220395','USAMD0023',5,109),
            ('PO220164','BORST0032',10,153),
            ('PO211226','ANSCO0049',50,28),
            ('PO211226','C071031T',150,43),
            ('PO211226','SEFCO0516ST',150,235),
            ('PO211226','C071026T',130,22),
            ('PO211226','C071026T',130,100),
            ('PO211226','C071025T',130,120),
            ('PO211089','LSEPA0040',9,615),
            ('PO211089','LSEPA0040',9,905),
            ('PO211091','PINPA0115',7,96),
            ('PO211091','PLAPA0032',7,246),
            ('PO211091','FSEMD0028',210,354),
            ('PO211091','LSEPA0039',11,630),
            ('PO211089','PLAPA0089',7,242),
            ('PO210814S','FSEMD0010',20,95),
            ('PO211091','PICMD0023',24,158),
            ('PO211091','PICMD0021',23,149),
            ('PO211091','PICMD0024',24,159),
            ('PO211091','PICMD0022',23,135),
            ('PO211091','FUSHD0013',2,168),
            ('PO211091','SPSPA0039',11,103),
            ('PO220127','SPAHD0019',2,406),
            ('PO220127','FUSHD0013',2,747),
            ('PO220127','PLIPA0004',8,237),
            ('PO220127','SPSPA0039',11,868),
            ('PO220138S','PICMD0024',24,58),
            ('PO220127','PLIPA0004',8,192),
            ('PO220127','PICMD0023',24,202),
            ('PO220138S','PICMD0022',23,159),
            ('PO220127','PSUPA0066',11,189),
            ('PO211092','PICMD0011',22,100),
            ('PO220129','ANSCO0024',1,118),
            ('PO211092','PICMD0010',23,117),
            ('PO211092','PICMD0009',23,133),
            ('PO211092','PLAPA0034',7,47),
            ('PO211092','PINPA0117',7,194),
            ('PO211092','POMPA0101',5,330),
            ('PO220394','PITPA0095',5,246),
            ('PO220394','POMPA0123',4,246),
            ('PO220394','POMPA0123',4,259),
            ('PO220363','TRAFA0066',70,392),
            ('PO220394','SSEPA0007',6,422),
            ('PO220245','LEGPA0062',13,194),
            ('PO220392','PSPHD0038',20,292),
            ('PO220392','TRAPA0102',90,246),
            ('PO220259','TRAPA0094',7,352),
            ('PO220257','PINPA0102',50,149),
            ('PO220245','PITPA0091',7,61),
            ('PO211226','ANSCO0049',50,32),
            ('PO211226','ANSCO0049',50,30),
            ('PO211226','DSFCO0670ST',160,64),
            ('PO211226','DSFCO0670ST',160,47),
            ('PO220392','PSPHD0037',40,304),
            ('PO220138S','PICFA0024',15,166),
            ('PO220138S','PICMD0012',22,61),
            ('PO220138S','PICMD0010',23,77),
            ('PO220138S','PICMD0009',23,66),
            ('PO220129','PICMD0010',23,92),
            ('PO220129','PICMD0009',23,164),
            ('PO220129','PICMD0011',22,233),
            ('PO220129','PICMD0012',22,142),
            ('PO211226','ANSCO0051',50,236),
            ('PO211226','ANSCO0050',50,61),
            ('PO211226','ANSCO0050',50,59),
            ('PO211226','ANSCO0050',50,108),
            ('PO220129','PSUPA0068',9,184),
            ('PO220129','POFPA0375',7,205),
            ('PO220129','POMPA0101',5,375),
            ('TR0501','PLAPA0034',6,123),
            ('PO211092','PLAPA0034',7,124),
            ('PO210741','PLAPA0034',7,124),
            ('PO220129','PINPA0117',7,170),
            ('PO220129','PLAPA0034',7,122),
            ('PO220129','PLAPA0034',7,123),
            ('PO220129','PLAPA0034',7,124),
            ('PO211226','ANSCO0049',50,40),
            ('PO220127','PICMD0021',23,369),
            ('PO220127','PICMD0022',23,302),
            ('PO220127','PICMD0024',24,409),
            ('PO220127','PICMD0023',24,250),
            ('PO220127','LSEPA0039',11,639),
            ('PO220127','PLAPA0032',7,479),
            ('PO220127','PLAPA0032',7,388),
            ('PO220127','PINPA0115',7,440),
            ('PO220130','PLAPA0030',50,284),
            ('PO211092','SPAHD0016',2,167),
            ('PO220257','POMPA0086',40,154),
            ('PO220391','PLAPA0012',60,137),
            ('PO220222','PSPHD0036',3,205),
            ('PO220245','POFPA0385',5,90),
            ('PO220245','POMPA0121',4,43),
            ('PO220245','POMPA0121',4,82),
            ('PO220245','LEGPA0063',92,200),
            ('PO220216','ADAST0004',3,299),
            ('PO220245','PITPA0091',7,62),
            ('PO220245','PITPA0091',7,79),
            ('PO220245','SSEPA0003',6,396),
            ('PO220391','PLAPA0012',60,193),
            ('PO220245','POFPA0385',5,25),
            ('PO220257','POMPA0086',40,176),
            ('PO220257','SPSPA0028',50,305),
            ('PO220257','LSEPA0029',70,293),
            ('PO220257','LSEPA0030',70,293),
            ('PO220214','COLFA0010',5,420),
            ('PO211144','SIPFA0006',3,71),
            ('PO220257','LEGPA0046',70,172),
            ('PO220219','TRAFA0005',4,1236),
            ('PO220257','POFPA0366',60,157),
            ('PO220364','LEGFA0036',20,224),
            ('PO211221','FUSHD0040',30,320),
            ('PO220391','FUSME0025',30,1301),
            ('PO211122','SIPFA0001',2,504),
            ('PO211221','ADAFA0015',20,224),
            ('PO210594','SPSPA0029',20,501),
            ('PO220221','COLFA0006',6,441),
            ('PO220245','PICFA0040',2,1026),
            ('PO220258','PSPHD0039',3,150),
            ('PO220391','PLAPA0012',60,133),
            ('PO220391','PLAPA0012',60,136),
            ('PO220391','PLAPA0012',60,135),
            ('PO220364','PANHD0079',20,400),
            ('PO220375','ADAFA0016',50,112),
            ('PO220364','PANHD0077',20,200),
            ('PO220124','ANSCP0420',1,180),
            ('PO220167','PICST0029',150,200),
            ('PO220167','PICST0028',150,176),
            ('PO220167','TRAST0028',130,219),
            ('PO220258','FUSHD0037',3,303),
            ('PO220122','PSUMD0009',160,63),
            ('PO220122','PSUMD0009',160,25),
            ('PO211224','TRFCO0511ST',120,71),
            ('PO211224','PAFCO0427ST',60,15),
            ('PO220259','FUSHD0031',3,187),
            ('PO210938','SIPFA8005',30,58),
            ('PO211224','TRFCO0511ST',120,29),
            ('PO220258','PSPHD0041',2,300),
            ('PO220130','PLAPA0030',50,18),
            ('PO220130','PLCPA0008',20,16),
            ('PO220130','POMPA0099',30,3),
            ('PO220234','PSUMD0006',160,78),
            ('PO220129','PICMD0010',23,75),
            ('PO220129','PICMD0009',23,17),
            ('PO220127','PICMD0023',24,30),
            ('PO220127','PICMD0024',24,31),
            ('PO220127','PICMD0022',23,123),
            ('PO220127','PICMD0021',23,61),
            ('PO220129','USAMD0005',18,72),
            ('PO220121','USAMD0012',19,17),
            ('PO211224','PICST0027',160,46),
            ('PO211224','PICST0028',160,42),
            ('PO211092','PICMD0012',22,35),
            ('PO220129','PICMD0011',2,42),
            ('PO220167','PAFCO0426ST',60,108),
            ('PO220167','PICST0030',150,204),
            ('PO211224','ANMCO0026',10,44),
            ('PO211224','TRAST0029',130,72),
            ('PO211224','PAFCO0428ST',60,48),
            ('PO220167','PAFCO0425ST',60,68),
            ('PO220125','PSUMD0013',160,2),
            ('PO220167','PAFCO0425ST',60,66),
            ('PO220167','PAFCO0425ST',60,69),
            ('PO220167','PAFCO0426ST',60,101),
            ('PO211230','MONMD0004',18,80),
            ('PO211082','ANSCO0004',1,13),
            ('PO220130','POMPA0099',30,93),
            ('PO220130','SPAHD0012',2,97),
            ('PO210890','PLAPA0030',20,81),
            ('PO211082','PLAPA0029',20,233),
            ('PO220391','TRAPA0062',90,547),
            ('PO211145','PICST0025',19,34),
            ('PO211145','PICST0026',19,27),
            ('PO210888','PSUMD0010',160,4),
            ('PO220483REP','PSUMD0004',160,47),
            ('PO210769','PICST0027',160,31),
            ('PO210769','PICST0028',160,29),
            ('PO211145R','PICST0025',18,50),
            ('PO220363','TABST0001',70,3720),
            ('PO220129','SPAHD0016',2,174),
            ('PO220167','TRAST0028',130,210),
            ('PO220363','GLSST0005',60,819),
            ('PO211280','D561213T',70,13),
            ('PO220362','SIPST0010',50,660),
            ('PO220296','SIPFA0007',14,434),
            ('PO220221','TRAST0005',5,111),
            ('PO210110','PICFA0024',15,511),
            ('PO220123','LSEPA0040',9,954),
            ('PO220124','PLAPA0089',7,366),
            ('PO220123','PLAPA0089',7,366),
            ('PO220123','PLAPA0089',7,365),
            ('PO220124','FSEMD0025',210,215),
            ('PO220123','SPSPA0077',10,361),
            ('PO220124','LSEPA0040',9,1098),
            ('PO220124','LSEPA0040',9,958),
            ('PO220123','SPSPA0049',9,371),
            ('PO220123','LEGPA0049',7,698),
            ('PO211089','PICFA0027',15,428),
            ('PO210887','PICFA0027',15,205),
            ('PO211089','LEGPA0049',7,64),
            ('PO220124','FSEMD0022',210,405),
            ('PO220127','PSUPA0066',11,239),
            ('PO220124','PICFA0016',15,32),
            ('PO220124','PICFA0019',15,22),
            ('PO220124','PICFA0024',15,19),
            ('PO220124','PICFA0027',15,19),
            ('PO220124','FSEMD0022',210,69),
            ('PO220124','FSEMD0025',210,46),
            ('PO220363','PANHD0076',20,404),
            ('PO210902','SPSPA0039',11,522),
            ('PO220124','PICFA0024',15,250),
            ('PO220124','PICFA0027',15,559),
            ('PO211089','PICFA0016',15,48),
            ('PO220128','PICFA0019',15,277),
            ('PO220124','SPSPA0043',10,233),
            ('PO220124','SPSPA0041',9,336),
            ('PO220124','FSEMD0025',210,112),
            ('PO220124','FSEMD0022',210,240),
            ('PO220124','PLAPA0089',7,51),
            ('PO220124','PLAPA0089',7,136),
            ('PO220128','LSEPA0059',8,833),
            ('PO220124','LSEPA0040',9,17),
            ('PO220124','PITPA0076',11,185),
            ('PO220124','FUSHD0024',2,730),
            ('PO211056','ANMCO0009',1,58),
            ('PO220171','ANMCO0007',1,60),
            ('PO211056','ANMCO0009',1,60),
            ('PO211057','PANHD0016',6,590),
            ('PO211055','TRAFA0026',16,449),
            ('PO210959','TRAFA0025',9,722),
            ('PO211055','TRAFA0026',16,1012),
            ('PO211056','PANHD0016',6,437),
            ('PO211055','ANMCO0007',1,60),
            ('PO211056','PANHD0016',6,562),
            ('PO211057','PANHD0016',6,1173),
            ('PO211057','PANHD0016',6,1052),
            ('PO210958','ANMCO0009',1,60),
            ('PO211056','ANMCO0009',1,68),
            ('PO211055','TRAFA0025',9,1500),
            ('PO210958','TRAFA0029',9,218),
            ('PO211056','TRAFA0030',16,386),
            ('PO211056','TRAFA0028',13,1498),
            ('PO211056','TRAFA0027',13,1485),
            ('PO210958','PICFA0049',7,259),
            ('PO211056','PICFA0047',7,383),
            ('PO211056','LEGFA0028',9,192),
            ('PO211056','LEGFA0028',9,1013),
            ('PO211056','LEGFA0029',11,854),
            ('PO211056','PICFA0049',7,366),
            ('PO211056','PICFA0046',7,701),
            ('PO210907','PICFA0046',7,211),
            ('PO210684','PICFA0048',7,617),
            ('PO210958R','LEGFA0029',11,494),
            ('PO211056','LEGFA0029',11,196),
            ('PO211055','DISFA0002',10,1255),
            ('PO211055','ANMCO0007',1,80),
            ('PO211056','DISFA0003',10,2781),
            ('PO211056','DISFA0003',10,163),
            ('PO220393','SOCMD0005',140,295),
            ('PO220137','TRAFA0011',7,832),
            ('PO220137','TRAFA0010',9,308),
            ('PO220139','TRAFA0010',9,308),
            ('PO220139','TRAFA0010',9,182),
            ('PO211185','MONFA0001',5,158),
            ('PO220139','MONFA0001',5,308),
            ('PO220139','MONFA0001',5,310),
            ('PO220137','MONFA0001',5,308),
            ('PO220137','MONFA0001',5,305),
            ('PO220139','MONFA0001',5,259),
            ('PO220110','MONFA0002',9,190),
            ('PO220110','TRAFA0013',15,42),
            ('PO220110','TARFA0002',11,830),
            ('PO211230','TRAMD0007',13,24),
            ('PO211230','MONMD0004',18,4),
            ('PO210959','PICFA0042',7,611),
            ('PO211055','PICFA0042',7,625),
            ('PO211055','TRAFA0023',13,401),
            ('PO211055','TRAFA0024',13,409),
            ('PO211055','PICFA0044',7,624),
            ('PO211055','LEGFA0024',9,490),
            ('PO211055','LEGFA0025',9,790),
            ('PO211055','PICFA0045',7,398),
            ('PO210959R','LEGFA0026',11,610),
            ('PO211055','PICFA0043',7,530),
            ('PO211055','PICFA0044',7,331),
            ('PO210684','PICFA0048',7,336),
            ('PO211056','PICFA0049',7,910),
            ('PO220228','PICMD0002',21,194),
            ('PO220228','PICMD0003',19,157),
            ('PO220228','PICMD0001',20,195),
            ('PO220228','PICMD0004',19,169),
            ('PO220110','LEGFA0012',11,485),
            ('PO210510','TARFA0002',11,492),
            ('PO220394','POFPA0387',7,80),
            ('PO210986','PICFA9000',10,105),
            ('PO220388','9019PARCC',1,3),
            ('PO220472','ANSCO0034',60,25),
            ('PO220464','ANSCO0032',6,50),
            ('PO220160','PREST0028',4,135),
            ('PO211227','MADSUC007',9,0.4050472),
            ('PO220472','MACSUC001',5,0.1703468),
            ('PO220472','MACSUC001',6,0.0654381),
            ('PO220375','ADAFA0016',50,248),
            ('PO220168','PALAM0003',2,33),
            ('PO211055','PICFA0045',7,486),
            ('PO210959','LEGFA0026',11,1175),
            ('PO210830','PICFA0046',7,317),
            ('PO210830','LEGFA0027',9,1193),
            ('PO210684','PICFA0047',7,928),
            ('PO220110','PALAM0003',2,16),
            ('PO220110','PALAM0003',2,20),
            ('PO220110','PALAM0003',1,34),
            ('PO220110','PALAM0003',2,25),
            ('PO211056','PICFA0046',7,185),
            ('PO211056','PICFA0047',7,185),
            ('PO211056','PICFA0048',7,185),
            ('PO211056','PICFA0049',7,185),
            ('PO211056','LEGFA0027',9,185),
            ('PO211056','LEGFA0028',9,185),
            ('PO211056','LEGFA0029',11,185),
            ('PO211055 AP','MEUCO1015',2,4),
            ('PO220110','0203BANCC',4,4),
            ('PO211226','ANSCO0049',50,24),
            ('PO220129','POFPA0375',7,135),
            ('PO210108','PICFA0016',15,676),
            ('PO211224','PICFA0052',40,158),
            ('PO220110','MONFA0002',9,484),
            ('PO220110','TRAFA0013',15,242),
            ('PO220110','TRAFA0014',14,242),
            ('PO220110','MONFA0002',9,480),
            ('PO220110','TRAFA0013',15,240),
            ('PO220110','TRAFA0014',14,240),
            ('PO211185','MONFA0001',5,322),
            ('PO211226','SCUST0001',130,1),
            ('PO210738','PLAPA0089',7,370),
            ('PO210571','PLIPA0004',8,34),
            ('PO210738','PLAPA0089',7,105),
            ('PO210738','SPSPA0077',10,2),
            ('PO220127','LSEPA0039',11,1056),
            ('PO210574','PICMD0012',22,205),
            ('PO220110','MONFA0002',9,600),
            ('PO220110','TRAFA0013',15,300),
            ('PO220110','TRAFA0014',14,300),
            ('PO220110','PSUPA0073',130,76),
            ('PO211230','TRAMD0007',14,134),
            ('PO211230','MONMD0003',17,72),
            ('PO211082','PLCPA0007',2,226),
            ('PO211082','POMPA0098',8,420),
            ('PO220258','PSPHD0040',2,232),
            ('PO211056','PMAMD0002',14,7),
            ('PO220110','PSUPA0073',130,42),
            ('PO220110','PSUPA0073',130,80),
            ('PO211185','TRAFA0010',9,229),
            ('PO220167','PICST0027',160,172);

    drop table if exists tbl_tmp_rezultat;

    create temp table tbl_tmp_rezultat as
    with lines_no as (
        select
            a.comanda,
            a.reper,
            a.oper,
            a.cantitate as inv_cantit,
            b."Line No_"
        from tbl_tmp_opers as a

        left join lateral
            (select distinct
                b1."Prod_ Order No_",
                first_value (b1."Line No_") over (partition by b1."Prod_ Order No_", b1."Item No_" order by b1."Line No_" desc
                                                rows between unbounded preceding and unbounded following) as "Line No_"
                from nav.tbl_int_prod_order_line as b1
                where a.comanda = b1."Prod_ Order No_" and a.reper = b1."Item No_") as b      
        on true
    ),
    curr_oper as (
        select
            a.comanda,
            a.reper,
            a.oper,
            (case when nullif(b."Next Operation No_", '') is null then 'FINAL' else 'INTERM' end) as oper_tip,
            a.inv_cantit,
            round(coalesce(sum(c."Output Quantity"), 0), 2) as nav_cantit
        from lines_no as a

        left join nav.tbl_int_prod_order_routing_line as b
        on a.comanda = b."Prod_ Order No_" and a."Line No_" = b."Routing Reference No_" and a.oper = replace(replace(b."Operation No_", '.', ''),',', '')::int

        left join (select * from nav.tbl_int_capacity_ledger_entry where "Posting Date"::date <= _status_date) as c
        on b."Prod_ Order No_" = c."Order No_" and b."Routing Reference No_" = c."Routing Reference No_" and b."Operation No_" = c."Operation No_"

        group by a.comanda,
                a.reper,
                a.oper,
                (case when nullif(b."Next Operation No_", '') is null then 'FINAL' else 'INTERM' end),
                a.inv_cantit
    ),
    last_oper as (
        select
            a.comanda,
            a.reper,
            a.oper as curr_oper,
            b."Operation No_" as last_oper,
            round(coalesce(sum(c."Output Quantity"), 0), 2) as out_cantit
        from lines_no as a

        left join nav.tbl_int_prod_order_routing_line as b
        on a.comanda = b."Prod_ Order No_" and a."Line No_" = b."Routing Reference No_" and nullif(b."Next Operation No_", '') is null

        left join (select * from nav.tbl_int_capacity_ledger_entry where "Posting Date"::date <= _status_date) as c
        on b."Prod_ Order No_" = c."Order No_" and b."Routing Reference No_" = c."Routing Reference No_" and b."Operation No_" = c."Operation No_"

        group by a.comanda,
            a.reper,
            a.oper,
            b."Operation No_"
    )
    select
        a.comanda,
        a.reper,
        a.oper,
        a.oper_tip,
        b.last_oper,
        a.inv_cantit,
        a.nav_cantit,
        coalesce(b.out_cantit, 0) as out_cantit,
        (case when coalesce(b.out_cantit, 0) = 0 then 'WIP' else
            case a.oper_tip when 'FINAL' then 'STOC' else            
                case when coalesce(b.out_cantit, 0) >= (a.nav_cantit - a.inv_cantit * 0.3) then 'STOC' else 'WIP' end
            end
        end) as tip_stoc
    from curr_oper as a

    left join last_oper as b
    on a.comanda = b.comanda and a.reper = b.reper and a.oper = b.curr_oper;
end;
$$ language plpgsql;

select * from tbl_tmp_rezultat;